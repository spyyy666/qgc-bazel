# .github/workflows/build-qgc-arm64-docker.yml
name: Build QGroundControl for ARM64 (Docker)

# on: [push, pull_request, workflow_dispatch]

jobs:
  build-arm64:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set up QEMU for ARM64 emulation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Build ARM64 Builder Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.arm64
        platforms: linux/arm64
        tags: qgc-arm64-builder:latest
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build QGroundControl in ARM64 Container
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          qgc-arm64-builder:latest \
          bash -c "
            echo 'ðŸ“¦ å»ºæ§‹ç’°å¢ƒè³‡è¨Š:'
            uname -a
            bazel version
            qt-cmake --version || echo 'Qt CMake not found, checking Qt installation...'
            find /opt/Qt -name 'qt-cmake' 2>/dev/null || echo 'Qt installation not found'
            echo
            echo 'ðŸ”¨ é–‹å§‹å»ºæ§‹ QGroundControl...'
            # ä½¿ç”¨ç°¡åŒ–çš„åŽŸç”Ÿé…ç½®
            cp BUILD.bazel.native BUILD.bazel
            bazel build //:qgroundcontrol_cmake
          "

    - name: Extract built artifacts
      run: |
        # è¤‡è£½å»ºæ§‹çµæžœ
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          qgc-arm64-builder:latest \
          bash -c "
            if [ -f bazel-bin/qgroundcontrol_cmake/QGroundControl ]; then
              cp bazel-bin/qgroundcontrol_cmake/QGroundControl ./QGroundControl-arm64
              echo 'âœ… æ‰¾åˆ° QGroundControl åŸ·è¡Œæª”'
              ls -la ./QGroundControl-arm64
            else
              echo 'âŒ æœªæ‰¾åˆ° QGroundControl åŸ·è¡Œæª”'
              echo 'å»ºæ§‹ç›®éŒ„å…§å®¹:'
              find bazel-bin -name '*QGroundControl*' -o -name '*qgroundcontrol*' 2>/dev/null || echo 'æ²’æœ‰æ‰¾åˆ°ç›¸é—œæª”æ¡ˆ'
            fi
          "

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: qgroundcontrol-arm64-docker
        path: QGroundControl-arm64
        if-no-files-found: ignore