name: Build QGroundControl ARM64

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    # ä½¿ç”¨åŸç”Ÿ ARM64 åŸ·è¡Œå™¨é¿å… QEMU æ¨¡æ“¬å•é¡Œ
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v3
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build ARM64 Docker image
      run: |
        echo "ğŸ”¨ å»ºç½® ARM64 Docker æ˜ åƒ..."
        docker buildx build \
          --platform linux/arm64 \
          --file docker/Dockerfile.arm64 \
          --tag qgc-arm64-builder:latest \
          --cache-from type=local,src=/tmp/.buildx-cache \
          --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
          --load \
          .
        
        # ç§»å‹•å¿«å–ä»¥é¿å…å¿«å–è†¨è„¹
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Verify Docker image
      run: |
        echo "ğŸ” é©—è­‰ Docker æ˜ åƒ..."
        docker run --rm --platform linux/arm64 qgc-arm64-builder:latest bash -c "
          echo '=== ç³»çµ±è³‡è¨Š ==='
          uname -a
          echo '=== ç·¨è­¯å™¨ ==='
          gcc --version | head -1
          echo '=== Qt æ¨¡çµ„ ==='
          find /opt/Qt -name 'Qt6StateMachine' -type d
          echo '=== ç’°å¢ƒè®Šæ•¸ ==='
          echo \"MAKEFLAGS=\$MAKEFLAGS\"
          echo \"CFLAGS=\$CFLAGS\"
        "

    - name: Run QGroundControl build
      timeout-minutes: 90
      run: |
        echo "ğŸš€ é–‹å§‹ QGroundControl ARM64 å»ºç½®..."
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          qgc-arm64-builder:latest \
          bash -c "
            echo '=== æº–å‚™å»ºç½®ç’°å¢ƒ ==='
            cp BUILD.bazel.native BUILD.bazel
            
            echo '=== å»ºç½®è¨­å®šæª¢æŸ¥ ==='
            cat BUILD.bazel | head -20
            
            echo '=== å–å¾— QGroundControl åŸå§‹ç¢¼ ==='
            timeout 600 bazel fetch //:qgroundcontrol_cmake || {
              echo 'âš ï¸  åŸå§‹ç¢¼ä¸‹è¼‰é€¾æ™‚ï¼Œå˜—è©¦ç¹¼çºŒå»ºç½®...'
            }
            
            echo '=== é–‹å§‹ç·¨è­¯ï¼ˆä½¿ç”¨ç©©å®šè¨­å®šï¼‰==='
            bazel build //:qgroundcontrol_cmake \\
              --verbose_failures \\
              --spawn_strategy=standalone \\
              --jobs=1 \\
              --local_ram_resources=2048 \\
              --local_cpu_resources=1 \\
              --subcommands=true \\
              --action_env=CC=gcc \\
              --action_env=CXX=g++ \\
              --action_env=MAKEFLAGS=-j1
          "

    - name: Check build results
      run: |
        echo "ğŸ“‹ æª¢æŸ¥å»ºç½®çµæœ..."
        if [ -d "bazel-bin" ]; then
          echo "æ‰¾åˆ° bazel-bin ç›®éŒ„ï¼š"
          find bazel-bin -name "*QGroundControl*" -type f | head -10
        else
          echo "âŒ bazel-bin ç›®éŒ„ä¸å­˜åœ¨"
        fi

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: qgroundcontrol-arm64
        path: |
          bazel-bin/**/*QGroundControl*
        retention-days: 7